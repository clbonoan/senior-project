<!DOCTYPE html>
<html lang="en">

<head>
  <title>Shadow Check</title>
  <link rel="stylesheet" href="{{ url_for('static', path='/style.css') }}">
  <link rel ="icon" type="image/x-icon" href="{{ url_for('static', path='favicon.png')}}">
</head>
<body>
  <nav class="navbar">
    <div class="nav-left">

      <a href="/">
        <img src="{{ url_for('static', path='/favicon.png') }}" alt="Home" class="nav-logo">
      </a>
    </div>
    <div class="nav-right">
          <a href="/repo"> Repository </a>
          <a href="/about"> About Us</a>
          <a href="/info"> Information</a>
      </div>
  </nav>

  <h1 id="home-title">Shadow Check</h1>
  <h3>Upload an image to see how our models detect
    <br> image tampering in urban infrastructure images through shadow features
  </h3>

  <form id="uploadForm">
    <label for="fileInput" class="custom-upload" id="customUpload">
      <div class="upload-title">Click to Upload Image</div>
      <div class="upload-info">Supports JPEG, JPG</div>
    </label>
    <input type="file" id="fileInput" name="file" hidden/>
  </form>

  <br>
  <div class="chooseMethod">Choose Detection Method</div>
  <br>
  <div class="methods">
    <button class="method" id="mlButton" type="button">
      <span class="method-title">Machine Learning</span>
      <small>Rule-Based + Random Forest</small>
    </button>
    <button class="method" id="dlButton" type="button">
      <span class="method-title">Deep Learning</span>
      <small>CNN-Based Detection</small>
    </button>
  </div>

  <div id="preview-container">
    <img id="preview" src="" alt="Image preview will appear here">
  </div>

  <div class="analyze-row">
    <button id="analyzeButton" type="button" disabled hidden>
      Analyze
    </button>
  </div>

  <div id="result"></div>

  <script>
    const fileInput = document.getElementById("fileInput");
    const preview = document.getElementById("preview");
    const upload = document.getElementById("customUpload");
    const analyzeButton = document.getElementById("analyzeButton");
    const mlButton = document.getElementById("mlButton");
    const dlButton = document.getElementById("dlButton");

    // Show image preview immediately when a file is chosen
    fileInput.addEventListener("change", () => {
      const file = fileInput.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          preview.src = e.target.result;
          preview.style.display = "block";
          };
        reader.readAsDataURL(file);
      } else {
        preview.src = "";
        preview.style.display = "none";
      }
      refreshAnalyzeState();
    });

    // toggle for which model to use (read flags on submit)
    let modelChoice = null;

    function setActive(whichId) {
      mlButton.classList.toggle("active", whichId === "mlButton");
      dlButton.classList.toggle("active", whichId === "dlButton");
    }
    setActive(null);  // clear initial selection

    mlButton.addEventListener("click", () => {
      modelChoice = "ml";
      setActive("mlButton");
      refreshAnalyzeState();
    });

    dlButton.addEventListener("click", () => {
      modelChoice = "dl";
      setActive("dlButton");
      refreshAnalyzeState();
    });

    // analyze button state
    function refreshAnalyzeState() {
      const hasModel = !!modelChoice;
      const hasFile = fileInput.files.length > 0;

      analyzeButton.hidden = !hasModel;
      analyzeButton.disabled = !(hasModel && hasFile);
    }
    refreshAnalyzeState();

    // clicking Analyze triggers submit
    analyzeButton.addEventListener("click", () => {
      document.getElementById("uploadForm").requestSubmit();
    });

    document.getElementById("uploadForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!fileInput.files.length) {
        alert("Please select an image first!");
        return;
      }

      const formData = new FormData();
      formData.append("file", fileInput.files[0]);
      formData.append("model", modelChoice);

      // Send to FastAPI
      const response = await fetch("/process/", {
        method: "POST",
        body: formData
      });

      // Read JSON response
      const data = await response.json();

      // Display score
      document.getElementById("result").innerHTML =
        `<b>Tamper Score:</b> ${data.tamper_score.toFixed(2)}<br>
         <small>(0 = normal, 1 = likely tampered)</small>`;
    });
  </script>

</body>
</html>
